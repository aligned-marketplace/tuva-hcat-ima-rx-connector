version: 2
models:
## Final
  - name: eligibility
    description: >
      Stub: no eligibility data in IMA Rx connector.
      Empty model satisfies Tuva dependency graph.
    config:
      schema: input_layer
      alias: eligibility
      materialized: table

  - name: medical_claim
    description: >
      Stub: no medical claim data in IMA Rx connector.
      Empty model satisfies Tuva dependency graph.
    config:
      schema: input_layer
      alias: medical_claim
      materialized: table

  - name: pharmacy_claim
    description: Final pharmacy claims for the input layer.
    config:
      schema: input_layer
      alias: pharmacy_claim
      materialized: table
    tests:
      - unique:
          column_name: "(claim_id || '-' || claim_line_number)"
    columns:
      - name: claim_id
        tests:
          - not_null
      - name: claim_line_number
        tests:
          - not_null
      - name: person_id
        tests:
          - not_null
      - name: ndc_code
        tests:
          - not_null:
              config:
                severity: warn
      - name: paid_amount
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                severity: warn
      - name: allowed_amount
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                severity: warn

## Intermediate
  - name: int_pharmacy_claim_adr
    description: >
      Applying adjustment / denial / reversal logic for pharmacy claims.
      All records are treated as final; claim_status is preserved but not
      used to filter.
    config:
      schema: _int_input_layer
      alias: pharmacy_claim_adr
      materialized: table

  - name: int_pharmacy_claim_deduped
    description: >
      Final de-duplication and financial field mapping for pharmacy claims.
      Joins to carrier eligibility lookup for person_id and plan.
    config:
      schema: _int_input_layer
      alias: pharmacy_claim_deduped
      materialized: table

  - name: int_carrier_eligibility_lookup
    description: >
      Unions Regence and Select Health eligibility, joins to IMA members
      on name + DOB, then deduplicates per individual_id to get the latest
      person_id and plan.
    config:
      schema: _int_input_layer
      alias: carrier_eligibility_lookup
      materialized: table

  ## Staging
  - name: stg_pharmacy_claim
    description: >
      Raw source mapping for IMA Rx pharmacy claims. Brings in all columns
      as-is with column renames and type casting only.
    config:
      schema: _stg_input_layer
      alias: pharmacy_claim
      materialized: table

  ## Data Quality
  - name: data_quality__claim_volume
    config:
      schema: connector_data_quality
      alias: claim_volume
      materialized: table

  - name: data_quality__pharmacy_claim_dedupe_accounting
    config:
      schema: connector_data_quality
      alias: pharmacy_claim_dedupe_accounting
      materialized: table

  - name: data_quality__summary
    description: >
      Summarizes the dedupe accounting for pharmacy claims.
    config:
      schema: connector_data_quality
      alias: summary
      materialized: table

  - name: ingestion__file_row_count
    config:
      schema: connector_data_quality
      alias: ingestion_file_row_count
      materialized: table
